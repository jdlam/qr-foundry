name: Release

on:
  push:
    branches: [main]
    paths: [CHANGELOG.md]

jobs:
  release:
    name: Create release from changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Parse latest changelog version
        id: changelog
        run: |
          VERSION=$(awk '/^## \[/ { s=$0; gsub(/^## \[/,"",s); gsub(/\].*/,"",s); if (s != "Unreleased") { print s; exit } }' CHANGELOG.md)
          if [ -z "$VERSION" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

          NOTES=$(awk -v ver="$VERSION" '
            BEGIN { found=0; printing=0 }
            /^## \[/ { if (printing) exit; s=$0; gsub(/^## \[/,"",s); gsub(/\].*/,"",s); if (s == ver) { found=1; printing=1; next } }
            printing { print }
          ' CHANGELOG.md | awk 'NF{f=1} f' | awk '{a[NR]=$0} END{for(i=NR;i>=1;i--) if(a[i]!=""){n=i;break} for(i=1;i<=n;i++) print a[i]}')

          if [ -z "$NOTES" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "$NOTES" > /tmp/release-notes.md
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Check if tag already exists
        if: steps.changelog.outputs.skip != 'true'
        id: check_tag
        run: |
          if git rev-parse "${{ steps.changelog.outputs.tag }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump version files
        if: steps.changelog.outputs.skip != 'true' && steps.check_tag.outputs.exists != 'true'
        run: |
          VERSION="${{ steps.changelog.outputs.version }}"

          # package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # package-lock.json
          npm install --package-lock-only --ignore-scripts

          # src-tauri/tauri.conf.json
          if [ -f src-tauri/tauri.conf.json ]; then
            node -e "
              const fs = require('fs');
              const p = 'src-tauri/tauri.conf.json';
              const conf = JSON.parse(fs.readFileSync(p, 'utf8'));
              conf.version = '$VERSION';
              fs.writeFileSync(p, JSON.stringify(conf, null, 2) + '\n');
            "
          fi

          # src-tauri/Cargo.toml
          if [ -f src-tauri/Cargo.toml ]; then
            sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$VERSION"'"/;}' src-tauri/Cargo.toml
          fi

          # src-tauri/Cargo.lock
          if [ -f src-tauri/Cargo.lock ]; then
            cd src-tauri
            cargo update --package qr-foundry --precise "$VERSION" 2>/dev/null \
              || sed -i '/^name = "qr-foundry"/{n;s/^version = ".*"/version = "'"$VERSION"'"/;}' Cargo.lock
            cd ..
          fi

      - name: Commit and push version bump
        if: steps.changelog.outputs.skip != 'true' && steps.check_tag.outputs.exists != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: release ${{ steps.changelog.outputs.tag }}"
            git push
          fi

      - name: Create GitHub Release
        if: steps.changelog.outputs.skip != 'true' && steps.check_tag.outputs.exists != 'true'
        run: |
          gh release create "${{ steps.changelog.outputs.tag }}" \
            --title "${{ steps.changelog.outputs.tag }}" \
            --notes-file /tmp/release-notes.md \
            --target main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
